#!/bin/bash

if [ ! "@MSYS_BIN_PATH_FOR_BUILD_DIR@"x = "x" ]; then
  export PATH=@MSYS_BIN_PATH_FOR_BUILD_DIR@:$PATH
fi

TOP_DIR=..
DIST_DIR=${TOP_DIR}/bin

ProjName="@CMAKE_PROJECT_NAME@"
signature=@CONFIG_W800_IMAGE_SIGNATURE@
prikey_sel=@CONFIG_W800_PRIKEY_SEL@
code_encrypt=@CONFIG_W800_CODE_ENCRYPT@
sign_pubkey_src=@CONFIG_W800_SIGN_PUBKEY_SRC@
img_type=@CONFIG_W800_IMAGE_TYPE@
zip_type=1

sec_img_header=8002000
sec_img_pos=8002400

run_img_header=@CONFIG_W800_IMAGE_HEADER_ADDR@
run_img_pos=@CONFIG_W800_IMAGE_APP_ADDR@
upd_img_pos=@CONFIG_W800_IMAGE_OTA_ADDR@

if [ $prikey_sel -gt 0 ]
 then
  let img_type=$img_type+32*$prikey_sel
fi

if [ $code_encrypt -eq 1 ]
 then
  let img_type=$img_type+16
fi

if [ $signature -eq 1 ]
 then
  let img_type=$img_type+256
fi

if [ $sign_pubkey_src -eq 1 ]
 then
  let img_type=$img_type+512
fi

echo " - image type     : $img_type"
echo " - signature      : $signature"
echo " - prikey_sel     : $prikey_sel"
echo " - code_encrypt   : $code_encrypt"
echo " - code_encrypt_k : @CONFIG_W800_CODE_ENCRYPT_KEY@"
echo " - sign_pubkey_src: $sign_pubkey_src"

csky-elfabiv2-objcopy -O binary ./"$ProjName".elf ./"$ProjName".bin

if [ $code_encrypt -eq 1 ]
 then
  let prikey_sel=$prikey_sel+1
  openssl enc -aes-128-ecb -in ./"$ProjName".bin -out ./"$ProjName"_enc.bin -K @CONFIG_W800_CODE_ENCRYPT_KEY@ -iv 01010101010101010101010101010101
  openssl rsautl -encrypt -in ${TOP_DIR}/tools/w800/ca/key.txt -inkey ${TOP_DIR}/tools/w800/ca/capub_"$prikey_sel".pem -pubin -out key_en.dat
  cat "$ProjName"_enc.bin key_en.dat > "$ProjName"_enc_key.bin
  cat "$ProjName"_enc_key.bin ${TOP_DIR}/tools/w800/ca/capub_"$prikey_sel"_N.dat > "$ProjName"_enc_key_N.bin  
  ${TOP_DIR}/tools/w800/wm_tool.exe -b ./"$ProjName"_enc_key_N.bin -o ./"$ProjName" -it $img_type -fc 0 -ra $run_img_pos -ih $run_img_header -ua $upd_img_pos -nh 0  -un 0
 else
  ${TOP_DIR}/tools/w800/wm_tool.exe -b ./"$ProjName".bin -o ./"$ProjName" -it $img_type -fc 0 -ra $run_img_pos -ih $run_img_header -ua $upd_img_pos -nh 0  -un 0
fi

mkdir -p ${DIST_DIR}

rm -f ${DIST_DIR}/*.img ${DIST_DIR}/*.gz ${DIST_DIR}/*.fls ${DIST_DIR}/*.map
cp -f "./$ProjName.map" "${DIST_DIR}/${ProjName}.map"

if [ $signature -eq 1 ]
 then
  openssl dgst -sign  ${TOP_DIR}/tools/w800/ca/cakey.pem -sha1 -out "$ProjName"_sign.dat ./"$ProjName".img
  cat "$ProjName".img "$ProjName"_sign.dat > "$ProjName"_sign.img
  mv ./"$ProjName"_sign.img ${DIST_DIR}/"$ProjName"_sign.img

  #when you change run-area image's ih, you must remake secboot img with secboot img's -nh address same as run-area image's ih
  ${TOP_DIR}/tools/w800/wm_tool.exe -b ${TOP_DIR}/tools/w800/w800_secboot.bin -o ${TOP_DIR}/tools/w800/w800_secboot -it 0 -fc 0 -ra $sec_img_pos -ih $sec_img_header -ua $upd_img_pos -nh $run_img_header  -un 0    
  cat ${TOP_DIR}/tools/w800/w800_secboot.img ${DIST_DIR}/"$ProjName"_sign.img > ${DIST_DIR}/"$ProjName".fls  
 else
  mv ./"$ProjName".img ${DIST_DIR}/"$ProjName".img

  #when you change run-area image's ih, you must remake secboot img with secboot img's -nh address same as run-area image's ih
  ${TOP_DIR}/tools/w800/wm_tool.exe -b ${TOP_DIR}/tools/w800/w800_secboot.bin -o ${TOP_DIR}/tools/w800/w800_secboot -it 0 -fc 0 -ra $sec_img_pos -ih $sec_img_header -ua $upd_img_pos -nh $run_img_header  -un 0  
  cat ${TOP_DIR}/tools/w800/w800_secboot.img ${DIST_DIR}/"$ProjName".img > ${DIST_DIR}/"$ProjName".fls
fi

#produce compressed ota firmware*/
if [ $zip_type -eq 1 ]
 then
  if [ $signature -eq 1 ]
   then
    ${TOP_DIR}/tools/w800/wm_tool.exe -b ./"$ProjName"_sign.img -o ${DIST_DIR}/"$ProjName"_sign -it $img_type -fc 1 -ra $run_img_pos -ih $run_img_header -ua $upd_img_pos -nh 0  -un 0
    mv ${DIST_DIR}/"$ProjName"_sign_gz.img ${DIST_DIR}/"$ProjName"_sign_ota.img
  else
   ${TOP_DIR}/tools/w800/wm_tool.exe -b ${DIST_DIR}/"$ProjName".img -o ${DIST_DIR}/"$ProjName" -it $img_type -fc 1 -ra $run_img_pos -ih $run_img_header -ua $upd_img_pos -nh 0  -un 0
   mv ${DIST_DIR}/"$ProjName"_gz.img ${DIST_DIR}/"$ProjName"_ota.img
  fi
fi
#openssl --help
